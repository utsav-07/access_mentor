sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel"],(e,t)=>{"use strict";return e.extend("com.ttl.accessmentor.controller.View1",{onInit(){this._initializeModel();this.getView().getModel().setProperty("/roleTypeFilter","standard")},_initializeModel:function(){var e={query:"",tcodes:[],extendedData:{PURCHASE:{query:"PURCHASE",tcodes:[{code:"ME21N"},{code:"ME51N",roles:[{name:"Z1_BC_SAP_REQ_CRT",sod:"",roleTcodes:["ME52N","ME53N"]}]},{code:"ME23N",roles:[{name:"Z1_BC_SAP_PUR_DISP",sod:"",roleTcodes:["ME21N"]}]},{code:"ME22N",roles:[{name:"Z1_BC_SAP_PUR_EDIT",sod:"EDIT CONFLICT",roleTcodes:["ME21N","ME23N"]}]},{code:"ME31K",roles:[{name:"Z1_BC_SAP_CONTRACT_CRT",sod:"",roleTcodes:["ME32K","ME33K"]}]},{code:"ME4100000000000000000000000000000000",roles:[{name:"Z1_BC_SAP_RFQ_CRT",sod:"RFQ SOD",roleTcodes:["ME42","ME43"]}]},{code:"ME51",roles:[{name:"Z1_BC_SAP_REQ_MANUAL",sod:"",roleTcodes:["ME52","ME53"]}]},{code:"ME11",roles:[{name:"Z1_BC_SAP_INFO_REC_CRT",sod:"",roleTcodes:["ME12","ME13"]}]},{code:"ME61",roles:[{name:"Z1_BC_SAP_VENDOR_EVAL",sod:"EVALUATION CONFLICT",roleTcodes:["ME62"]}]},{code:"ME91E",roles:[{name:"Z1_BC_SAP_REMIND_PO",sod:"",roleTcodes:["ME9E"]}]},{code:"ME91E",roles:[{name:"Z1_BC_SAP_REMIND_PO",sod:"",roleTcodes:["ME9E"]}]},{code:"ME91E",roles:[{name:"Z1_BC_SAP_REMIND_PO",sod:"",roleTcodes:["ME9E"]}]},{code:"ME91E",roles:[{name:"Z1_BC_SAP_REMIND_PO",sod:"",roleTcodes:["ME9E"]}]},{code:"ME91E",roles:[{name:"Z1_BC_SAP_REMIND_PO",sod:"",roleTcodes:["ME9E"]}]}]},INVOICE:{query:"INVOICE",tcodes:[{code:"MIRO",roles:[{name:"Z1_BC_SAP_INV_POST",sod:"INVOICE SOD CONFLICT",roleTcodes:["MIR4","MIR6"]}]}]},GRN:{query:"GRN",tcodes:[{code:"MM01",roles:[{name:"Z1_BC_SAP_GRN_DIS",sod:"SOD ANALYSIS",roleTcodes:["PFCG"]}]},{code:"MM02",roles:[{name:"Z1_BC_SAP_GRN_CRT",sod:"",roleTcodes:["SU53"]}]}]}},availableRoles:[],selectedRoleSOD:"",selectedRoleTcodes:[],selectedTCodesCount:0,selectedRolesCount:0,hasSOD:false,noSODVisible:false,selectRoleVisible:true,showAddTCodeInput:false,newTCodeValue:"",isOwnSelected:true,isOtherSelected:false,otherSapId:"",sodTableData:[{userId:"U123450",accessRiskId:"AR001",system:"SAPPRD",ruleId:"R1001",riskLevel:"High",action:"Approve",lastExecutedOn:"2024-06-01",executionCount:"5",control:"Yes",monitor:"No",orgRuleId:"ORG001"},{userId:"U123450",accessRiskId:"AR001",system:"SAPPRD",ruleId:"R1001",riskLevel:"High",action:"Approve",lastExecutedOn:"2024-06-01",executionCount:"5",control:"Yes",monitor:"No",orgRuleId:"ORG001"},{userId:"U123450",accessRiskId:"AR001",system:"SAPPRD",ruleId:"R1001",riskLevel:"High",action:"Approve",lastExecutedOn:"2024-06-01",executionCount:"5",control:"Yes",monitor:"No",orgRuleId:"ORG001"},{userId:"U123450",accessRiskId:"AR001",system:"SAPPRD",ruleId:"R1001",riskLevel:"High",action:"Approve",lastExecutedOn:"2024-06-01",executionCount:"5",control:"Yes",monitor:"No",orgRuleId:"ORG001"},{userId:"U123450",accessRiskId:"AR001",system:"SAPPRD",ruleId:"R1001",riskLevel:"High",action:"Approve",lastExecutedOn:"2024-06-01",executionCount:"5",control:"Yes",monitor:"No",orgRuleId:"ORG001"},{userId:"U123450",accessRiskId:"AR001",system:"SAPPRD",ruleId:"R1001",riskLevel:"High",action:"Approve",lastExecutedOn:"2024-06-01",executionCount:"5",control:"Yes",monitor:"No",orgRuleId:"ORG001"},{userId:"U123450",accessRiskId:"AR001",system:"SAPPRD",ruleId:"R1001",riskLevel:"High",action:"Approve",lastExecutedOn:"2024-06-01",executionCount:"5",control:"Yes",monitor:"No",orgRuleId:"ORG001"},{userId:"U123450",accessRiskId:"AR001",system:"SAPPRD",ruleId:"R1001",riskLevel:"High",action:"Approve",lastExecutedOn:"2024-06-01",executionCount:"5",control:"Yes",monitor:"No",orgRuleId:"ORG001"},{userId:"U123450",accessRiskId:"AR001",system:"SAPPRD",ruleId:"R1001",riskLevel:"High",action:"Approve",lastExecutedOn:"2024-06-01",executionCount:"5",control:"Yes",monitor:"No",orgRuleId:"ORG001"},{userId:"U67890",accessRiskId:"AR002",system:"SAPDEV",ruleId:"R1002",riskLevel:"Medium",action:"Review",lastExecutedOn:"2024-05-28",executionCount:"2",control:"No",monitor:"Yes",orgRuleId:"ORG002"}],showSODTable:false,tcodeBusy:false,roleBusy:false,infoCenterBusy:false,sodBusy:false,showStandardRoles:true,showNonStandardRoles:true};var o=new t(e);this.getView().setModel(o)},onQueryChange:function(e){var t=this.getView();var o=t.byId("tcodeVBox");var s=this.getView().getModel();s.setProperty("/tcodeBusy",true);o.addStyleClass("busyTop");var r=e.getParameter("query").toUpperCase();var n=s.getData();this._resetSelections();if(r.trim()===""){s.setProperty("/query","");s.setProperty("/tcodes","");o.removeStyleClass("busyTop");s.setProperty("/tcodeBusy",false);return}if(n.extendedData[r]){var l=n.extendedData[r];s.setProperty("/query",l.query);s.setProperty("/tcodes",l.tcodes)}else{var a=n.tcodes.filter(function(e){return e.code.includes(r)||e.roles.some(function(e){return e.name.includes(r)})});s.setProperty("/query",r);s.setProperty("/tcodes",a)}s.setProperty("/tcodeBusy",false);o.removeStyleClass("busyTop")},onRadioSelect:function(e){var t=this.getView().getModel();var o=e.getSource().getText();if(o==="Own"){t.setProperty("/isOwnSelected",true);t.setProperty("/isOtherSelected",false)}else{t.setProperty("/isOwnSelected",false);t.setProperty("/isOtherSelected",true)}},onTCodeSelectionChange:async function(e){const t=this.getView();const o=e.getSource();var s=t.byId("roleVBox");const r=o.getSelectedItems();const n=this.getView().getModel();const l=this.getOwnerComponent().getModel();console.log(l);var a=n.getProperty("/isOwnSelected");var i=n.getProperty("/isOtherSelected");var c="";if(i){c=n.getProperty("/otherSapId")||""}n.setProperty("/roleBusy",true);s.addStyleClass("busyTop");let d=[];for(const e of r){const t=e.getBindingContext().getProperty("code");const o=`Tcode eq '${t}' and TestUser eq '${c}'`;console.log(o);try{const e=await new Promise(e=>{l.read("/Get_roleSet",{urlParameters:{$filter:o},success:t=>e(t),error:()=>e({results:[]})})});d=d.concat(e.results||[])}catch(e){console.error(`Failed to fetch roles for ${t}`,e)}}const u=new Set;const p=d.filter(e=>{const t=e.Roles||e.name;if(u.has(t)){return false}u.add(t);return true});n.setProperty("/_allAvailableRoles",p);this.onRoleTypeCheckboxSelect();n.setProperty("/selectedTCodesCount",r.length);n.setProperty("/roleBusy",false);s.removeStyleClass("busyTop");this._updateUIState()},onTCodePress:function(e){const t=this.getView();const o=t.byId("infoCenterVBox");o.addStyleClass("busyTop");var s=this.getView().getModel();var r=e.getSource().getBindingContext().getObject();var n=this.getOwnerComponent().getModel();var l=r.code;if(!l)return;s.setProperty("/infoCenterBusy",true);var a=`Tcode eq '${l}'`;n.read("/all_tcodeSet",{urlParameters:{$filter:a},success:function(e){const t=e.results.map(e=>({code:e.Tcode,description:e.RoleDesc?e.RoleDesc:"No description available"}));s.setProperty("/selectedRoleTcodes",t);s.setProperty("/infoCenterBusy",false);o.removeStyleClass("busyTop")},error:function(){s.setProperty("/selectedRoleTcodes",[]);s.setProperty("/infoCenterBusy",false);o.removeStyleClass("busyTop")}})},onRoleSelectionChange:function(e){var t=this.byId("roleList");var o=t.getSelectedItems();var s=this.getView().getModel();var r=[];var n=[];o.forEach(function(e){var o=e.getBindingContext();var s=o.getObject();if(s.Exist==="X"){t.setSelectedItem(e,false);sap.m.MessageToast.show("Role '"+(s.name||s.Roles)+"' is already assigned.")}else{r.push(e);n.push(s.Roles||s.name)}});s.setProperty("/selectedRoles",n);if(o.length>0){var l=o[o.length-1];var a=l.getBindingContext().getObject();s.setProperty("/selectedRoleSOD",a.sod)}s.setProperty("/selectedRolesCount",o.length);this._updateUIState()},onRolePress:function(e){const t=this.getView();const o=t.byId("infoCenterVBox");o.addStyleClass("busyTop");var s=this.getView().getModel();var r=e.getSource().getBindingContext().getObject();var n=this.getOwnerComponent().getModel();var l=r.Roles||r.name;if(!l)return;s.setProperty("/infoCenterBusy",true);o.addStyleClass("busyTop");var a=this;var i=`Roles eq '${l}'`;n.read("/Get_TcodeSet",{urlParameters:{$filter:i},success:function(e){var t=(e.results||[]).map(function(e){return{code:e.Tcode,description:e.RoleDesc}});s.setProperty("/selectedRoleTcodes",t);s.setProperty("/infoCenterBusy",false);o.removeStyleClass("busyTop")},error:function(){s.setProperty("/selectedRoleTcodes",[]);s.setProperty("/infoCenterBusy",false);o.removeStyleClass("busyTop")}})},_resetSelections:function(){var e=this.getView().getModel();this.byId("tcodeList").removeSelections();this.byId("roleList").removeSelections();e.setProperty("/tcodes","");e.setProperty("/availableRoles",[]);e.setProperty("/_allAvailableRoles",[]);e.setProperty("/selectedRoleSOD","");e.setProperty("/selectedRoleTcodes",[]);e.setProperty("/selectedTCodesCount",0);e.setProperty("/selectedRolesCount",0);this._updateUIState()},_updateRoleSelectionState:function(){var e=this.getView().getModel();e.setProperty("/selectedRoleSOD","");e.setProperty("/selectedRoleTcodes",[]);e.setProperty("/selectedRolesCount",0)},_updateUIState:function(){var e=this.getView().getModel();var t=e.getProperty("/selectedRoleSOD");var o=e.getProperty("/selectedRolesCount");e.setProperty("/hasSOD",!!(t&&t.length>0));e.setProperty("/noSODVisible",o>0&&(!t||t.length===0));e.setProperty("/selectRoleVisible",o===0)},onAddTCodePress:function(){var e=this.getView().getModel();e.setProperty("/showAddTCodeInput",true);e.setProperty("/newTCodeValue","")},_validateTcodesWithOData:async function(e){const t=this.getOwnerComponent().getModel();if(!e||e.length===0)return[];const o=e.map(e=>`Tcode eq '${e.code}'`).join(" or ");return new Promise(e=>{t.read("/all_tcodeSet",{urlParameters:{$filter:o},success:function(t){const o=t.results.map(e=>({code:e.Tcode,description:e.RoleDesc?e.RoleDesc:"No description available"}));e(o)},error:function(){e([])}})})},onAddTCodeSubmit:async function(e){var t=this.getView().getModel();var o=t.getProperty("/newTCodeValue");if(o&&o.trim()!==""){var s=t.getProperty("/tcodes")||[];var r=await this._validateTcodesWithOData([{code:o.toUpperCase()}]);if(r.length>0){s.push(r[0]);t.setProperty("/tcodes",s)}else{sap.m.MessageToast.show("T-Code '"+o+"' does not exist in the system.")}}t.setProperty("/showAddTCodeInput",false);t.setProperty("/newTCodeValue","")},onSearchSubmit:async function(e){this._resetSelections();var t=this.getView();var o=t.byId("tcodeVBox");const s=e.getParameter("query");const r=this.getView().getModel();r.setProperty("/tcodeBusy",true);o.addStyleClass("busyTop");r.setProperty("/query",s);if(!s||s.trim()===""){r.setProperty("/query","");r.setProperty("/tcodes",[]);o.removeStyleClass("busyTop");r.setProperty("/tcodeBusy",false);return}const n=await this._callHuggingFaceForTcodes(s);const l=await this._validateTcodesWithOData(n);r.setProperty("/tcodes",l);r.setProperty("/tcodeBusy",false);o.removeStyleClass("busyTop")},_callHuggingFaceForTcodes:async function(e){const t="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";const o=`You are an SAP expert. List SAP T-Codes with their descriptions needed for the task: "${e}". Return the result as valid JSON array like:\n        [\n          { "code": "ME21N", "description": "Create Purchase Order" },\n          { "code": "ME23N", "description": "Display Purchase Order" }\n        ]`;try{const e=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4o-mini",messages:[{role:"system",content:"You are an SAP expert assistant."},{role:"user",content:o}],temperature:.2,max_tokens:300})});const s=await e.json();const r=s.choices?.[0]?.message?.content||"";let n=r.replace(/```[\s\S]*?```/g,e=>e.replace(/```(?:json)?/gi,"").replace(/```/g,"")).trim();let l=n.indexOf("[");if(l!==-1){let e=n.substring(l);let t=e.lastIndexOf("}");if(t!==-1){let o=e.substring(0,t+1);if(!o.trim().endsWith("]")){o+="]"}try{return JSON.parse(o)}catch(e){let t=o.lastIndexOf("},");if(t!==-1){let e=o.substring(0,t+1)+"]";try{sap.m.MessageToast.show("The AI response was incomplete. Only partial data is shown.");return JSON.parse(e)}catch(t){sap.m.MessageToast.show("The AI response was incomplete. Only partial data is shown.");console.warn("Failed to parse JSON after fix:",t,e);return[]}}sap.m.MessageToast.show("The AI response was incomplete or malformed. Please try again or rephrase your query.");console.warn("OpenAI response format unrecognized:",e,o);return[]}}}sap.m.MessageToast.show("The AI response was incomplete or malformed. Please try again or rephrase your query.");console.warn("OpenAI response format unrecognized:",r);return[]}catch(e){console.error("OpenAI API error:",e);return[]}},onSendSODPress:function(){var e=this.getView().getModel();var t=this.getOwnerComponent().getModel("sod");console.log(t);var o=e.getProperty("/selectedRoles")||[];var s=e.getProperty("/isOwnSelected");var r=e.getProperty("/isOtherSelected");var n="";if(r){n=e.getProperty("/otherSapId")||""}if(!o.length){e.setProperty("/sodTableData",[]);e.setProperty("/showSODTable",false);sap.m.MessageToast.show("Please select at least one role.");return}var l=o.map(function(e){return new sap.ui.model.Filter("Roles",sap.ui.model.FilterOperator.EQ,e)});var a=new sap.ui.model.Filter({filters:l,and:false});var i=new sap.ui.model.Filter("User",sap.ui.model.FilterOperator.EQ,n);var c=new sap.ui.model.Filter({filters:[a,i],and:true});e.setProperty("/sodBusy",true);t.read("/ZGRC_SODSet",{filters:[c],success:function(t){console.log("SOD API result:",t);e.setProperty("/sodTableData",t.results||[]);e.setProperty("/showSODTable",true);e.setProperty("/sodBusy",false)},error:function(t){e.setProperty("/sodBusy",false);sap.m.MessageToast.show("Failed to check SOD.");console.error("SOD API error:",t)}})},onApplyPress:function(){console.log("Apply button pressed")},onRoleTypeCheckboxSelect:function(){var e=this.getView().getModel();var t=e.getProperty("/showStandardRoles");var o=e.getProperty("/showNonStandardRoles");var s=e.getProperty("/_allAvailableRoles")||[];var r=e.getProperty("/selectedRoles")||[];var n=s.filter(function(e){var s=e.Roles||e.name||"";var r=s.toUpperCase().startsWith("SAP");return t&&r||o&&!r});e.setProperty("/availableRoles",n);setTimeout(function(){var e=this.byId("roleList");var t=e.getItems();t.forEach(function(t){var o=t.getBindingContext().getObject();if(r.includes(o.Roles)){e.setSelectedItem(t,true)}else{e.setSelectedItem(t,false)}})}.bind(this),0)},onRoleListUpdateFinished:function(){var e=this.byId("roleList");var t=e.getItems();t.forEach(function(e){e.removeStyleClass("hideRoleCheckbox");var t=e.getBindingContext();if(!t)return;var o=t.getObject();console.log(o);if(o.Exist==="X"){e.addStyleClass("hideRoleCheckbox")}})},onSodTableItemPress:function(e){var t=e.getSource();var o=t.getBindingContext();if(o){var s=o.getObject();console.log("Riskdesc:",s.Riskdesc,"Riskid:",s.Riskid);var r=this.getView().getModel();r.setProperty("/selectedRoleTcodes",[{code:s.Riskid||"",description:s.Riskdesc||""}])}},getRowHighlight:function(e){switch(e){case"Critical":return"Error";case"High":return"Error";case"Medium":return"Indication08";case"Low":return"Indication05";default:return"None"}}})});
//# sourceMappingURL=View1.controller.js.map